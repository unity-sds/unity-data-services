import json
import os
from unittest import TestCase

from mdps_ds_lib.lib.utils.time_utils import TimeUtils
from pystac import ItemCollection

from cumulus_lambda_functions.granules_cnm_ingester.granules_cnm_ingester_logic import GranulesCnmIngesterLogic


class TestGranulesCnmIngesterLogic(TestCase):

    def __init__(self, methodName: str = ...) -> None:
        super().__init__(methodName)
        os.environ['SNS_TOPIC_ARN'] = 'arn:aws:sns:us-west-2:237868187491:uds-sbx-cumulus-cnm-submission-sns'
        os.environ['COLLECTION_CREATION_LAMBDA_NAME'] = 'NA'
        os.environ['UNITY_DEFAULT_PROVIDER'] = 'unity'
        os.environ['CUMULUS_WORKFLOW_NAME'] = 'CatalogGranule'
        os.environ['REPORT_TO_EMS'] = 'FALSE'
        os.environ['CUMULUS_LAMBDA_PREFIX'] = 'uds-sbx-cumulus'
        os.environ['CUMULUS_WORKFLOW_SQS_URL'] = 'https://sqs.us-west-2.amazonaws.com/237868187491/uds-sbx-cumulus-cnm-submission-queue'
        os.environ['ES_URL'] = 'vpc-uds-sbx-cumulus-es-qk73x5h47jwmela5nbwjte4yzq.us-west-2.es.amazonaws.com'
        os.environ['ES_PORT'] = '9200'

    def test_load_successful_features_s3(self):
        s3_url = 's3://uds-sbx-cumulus-staging/integration_test/stag_eout/successful_features_2024-04-11T21:21:13.019769.json'
        a = GranulesCnmIngesterLogic().load_successful_features_s3(s3_url)
        return

    def test_validate_granules(self):
        result = {"type": "FeatureCollection", "features": [{"type": "Feature", "stac_version": "1.0.0", "id": "NEW_COLLECTION_EXAMPLE_L1B___9:test_file01", "properties": {"start_datetime": "2016-01-31T18:00:00.009057Z", "end_datetime": "2016-01-31T19:59:59.991043Z", "created": "2016-02-01T02:45:59.639000Z", "updated": "2022-03-23T15:48:21.578000Z", "datetime": "1970-01-01T00:00:00Z"}, "geometry": {"type": "Point", "coordinates": [0.0, 0.0]}, "links": [], "assets": {"test_file01.nc": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file01/test_file01.nc", "title": "test_file01.nc", "roles": ["data"]}, "test_file01.nc.cas": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file01/test_file01.nc.cas", "title": "test_file01.nc.cas", "roles": ["metadata"]}, "test_file01.nc.stac.json": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file01/test_file01.nc.stac.json", "title": "test_file01.nc.stac.json", "roles": ["metadata"]}}, "bbox": [0.0, 0.0, 0.0, 0.0], "stac_extensions": [], "collection": "NEW_COLLECTION_EXAMPLE_L1B___9"}, {"type": "Feature", "stac_version": "1.0.0", "id": "NEW_COLLECTION_EXAMPLE_L1B___9:test_file02", "properties": {"start_datetime": "2016-01-31T18:00:00.009057Z", "end_datetime": "2016-01-31T19:59:59.991043Z", "created": "2016-02-01T02:45:59.639000Z", "updated": "2022-03-23T15:48:21.578000Z", "datetime": "1970-01-01T00:00:00Z"}, "geometry": {"type": "Point", "coordinates": [0.0, 0.0]}, "links": [], "assets": {"test_file02.nc": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file02/test_file02.nc", "title": "test_file01.nc", "roles": ["data"]}, "test_file02.nc.cas": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file02/test_file02.nc.cas", "title": "test_file01.nc.cas", "roles": ["metadata"]}, "test_file02.nc.stac.json": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file02/test_file02.nc.stac.json", "title": "test_file01.nc.stac.json", "roles": ["metadata"]}}, "bbox": [0.0, 0.0, 0.0, 0.0], "stac_extensions": [], "collection": "NEW_COLLECTION_EXAMPLE_L1B___9"}, {"type": "Feature", "stac_version": "1.0.0", "id": "NEW_COLLECTION_EXAMPLE_L1B___9:test_file03", "properties": {"start_datetime": "2016-01-31T18:00:00.009057Z", "end_datetime": "2016-01-31T19:59:59.991043Z", "created": "2016-02-01T02:45:59.639000Z", "updated": "2022-03-23T15:48:21.578000Z", "datetime": "1970-01-01T00:00:00Z"}, "geometry": {"type": "Point", "coordinates": [0.0, 0.0]}, "links": [], "assets": {"test_file03.nc": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file03/test_file03.nc", "title": "test_file01.nc", "roles": ["data"]}, "test_file03.nc.cas": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file03/test_file03.nc.cas", "title": "test_file01.nc.cas", "roles": ["metadata"]}, "test_file03.nc.stac.json": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file03/test_file03.nc.stac.json", "title": "test_file01.nc.stac.json", "roles": ["metadata"]}}, "bbox": [0.0, 0.0, 0.0, 0.0], "stac_extensions": [], "collection": "NEW_COLLECTION_EXAMPLE_L1B___9"}, {"type": "Feature", "stac_version": "1.0.0", "id": "NEW_COLLECTION_EXAMPLE_L1B___9:test_file04", "properties": {"start_datetime": "2016-01-31T18:00:00.009057Z", "end_datetime": "2016-01-31T19:59:59.991043Z", "created": "2016-02-01T02:45:59.639000Z", "updated": "2022-03-23T15:48:21.578000Z", "datetime": "1970-01-01T00:00:00Z"}, "geometry": {"type": "Point", "coordinates": [0.0, 0.0]}, "links": [], "assets": {"test_file04.nc": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file04/test_file04.nc", "title": "test_file01.nc", "roles": ["data"]}, "test_file04.nc.cas": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file04/test_file04.nc.cas", "title": "test_file01.nc.cas", "roles": ["metadata"]}, "test_file04.nc.stac.json": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file04/test_file04.nc.stac.json", "title": "test_file01.nc.stac.json", "roles": ["metadata"]}}, "bbox": [0.0, 0.0, 0.0, 0.0], "stac_extensions": [], "collection": "NEW_COLLECTION_EXAMPLE_L1B___9"}, {"type": "Feature", "stac_version": "1.0.0", "id": "NEW_COLLECTION_EXAMPLE_L1B___9:test_file05", "properties": {"start_datetime": "2016-01-31T18:00:00.009057Z", "end_datetime": "2016-01-31T19:59:59.991043Z", "created": "2016-02-01T02:45:59.639000Z", "updated": "2022-03-23T15:48:21.578000Z", "datetime": "1970-01-01T00:00:00Z"}, "geometry": {"type": "Point", "coordinates": [0.0, 0.0]}, "links": [], "assets": {"test_file05.nc": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file05/test_file05.nc", "title": "test_file01.nc", "roles": ["data"]}, "test_file05.nc.cas": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file05/test_file05.nc.cas", "title": "test_file01.nc.cas", "roles": ["metadata"]}, "test_file05.nc.stac.json": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file05/test_file05.nc.stac.json", "title": "test_file01.nc.stac.json", "roles": ["metadata"]}}, "bbox": [0.0, 0.0, 0.0, 0.0], "stac_extensions": [], "collection": "NEW_COLLECTION_EXAMPLE_L1B___9"}, {"type": "Feature", "stac_version": "1.0.0", "id": "NEW_COLLECTION_EXAMPLE_L1B___9:test_file06", "properties": {"start_datetime": "2016-01-31T18:00:00.009057Z", "end_datetime": "2016-01-31T19:59:59.991043Z", "created": "2016-02-01T02:45:59.639000Z", "updated": "2022-03-23T15:48:21.578000Z", "datetime": "1970-01-01T00:00:00Z"}, "geometry": {"type": "Point", "coordinates": [0.0, 0.0]}, "links": [], "assets": {"test_file06.nc": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file06/test_file06.nc", "title": "test_file01.nc", "roles": ["data"]}, "test_file06.nc.cas": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file06/test_file06.nc.cas", "title": "test_file01.nc.cas", "roles": ["metadata"]}, "test_file06.nc.stac.json": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file06/test_file06.nc.stac.json", "title": "test_file01.nc.stac.json", "roles": ["metadata"]}}, "bbox": [0.0, 0.0, 0.0, 0.0], "stac_extensions": [], "collection": "NEW_COLLECTION_EXAMPLE_L1B___9"}, {"type": "Feature", "stac_version": "1.0.0", "id": "NEW_COLLECTION_EXAMPLE_L1B___9:test_file08", "properties": {"start_datetime": "2016-01-31T18:00:00.009057Z", "end_datetime": "2016-01-31T19:59:59.991043Z", "created": "2016-02-01T02:45:59.639000Z", "updated": "2022-03-23T15:48:21.578000Z", "datetime": "1970-01-01T00:00:00Z"}, "geometry": {"type": "Point", "coordinates": [0.0, 0.0]}, "links": [], "assets": {"test_file08.nc": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file08/test_file08.nc", "title": "test_file01.nc", "roles": ["data"]}, "test_file08.nc.cas": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file08/test_file08.nc.cas", "title": "test_file01.nc.cas", "roles": ["metadata"]}, "test_file08.nc.stac.json": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file08/test_file08.nc.stac.json", "title": "test_file01.nc.stac.json", "roles": ["metadata"]}}, "bbox": [0.0, 0.0, 0.0, 0.0], "stac_extensions": [], "collection": "NEW_COLLECTION_EXAMPLE_L1B___9"}, {"type": "Feature", "stac_version": "1.0.0", "id": "NEW_COLLECTION_EXAMPLE_L1B___9:test_file07", "properties": {"start_datetime": "2016-01-31T18:00:00.009057Z", "end_datetime": "2016-01-31T19:59:59.991043Z", "created": "2016-02-01T02:45:59.639000Z", "updated": "2022-03-23T15:48:21.578000Z", "datetime": "1970-01-01T00:00:00Z"}, "geometry": {"type": "Point", "coordinates": [0.0, 0.0]}, "links": [], "assets": {"test_file07.nc": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file07/test_file07.nc", "title": "test_file01.nc", "roles": ["data"]}, "test_file07.nc.cas": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file07/test_file07.nc.cas", "title": "test_file01.nc.cas", "roles": ["metadata"]}, "test_file07.nc.stac.json": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file07/test_file07.nc.stac.json", "title": "test_file01.nc.stac.json", "roles": ["metadata"]}}, "bbox": [0.0, 0.0, 0.0, 0.0], "stac_extensions": [], "collection": "NEW_COLLECTION_EXAMPLE_L1B___9"}, {"type": "Feature", "stac_version": "1.0.0", "id": "NEW_COLLECTION_EXAMPLE_L1B___9:test_file10", "properties": {"start_datetime": "2016-01-31T18:00:00.009057Z", "end_datetime": "2016-01-31T19:59:59.991043Z", "created": "2016-02-01T02:45:59.639000Z", "updated": "2022-03-23T15:48:21.578000Z", "datetime": "1970-01-01T00:00:00Z"}, "geometry": {"type": "Point", "coordinates": [0.0, 0.0]}, "links": [], "assets": {"test_file10.nc": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file10/test_file10.nc", "title": "test_file01.nc", "roles": ["data"]}, "test_file10.nc.cas": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file10/test_file10.nc.cas", "title": "test_file01.nc.cas", "roles": ["metadata"]}, "test_file10.nc.stac.json": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file10/test_file10.nc.stac.json", "title": "test_file01.nc.stac.json", "roles": ["metadata"]}}, "bbox": [0.0, 0.0, 0.0, 0.0], "stac_extensions": [], "collection": "NEW_COLLECTION_EXAMPLE_L1B___9"}, {"type": "Feature", "stac_version": "1.0.0", "id": "NEW_COLLECTION_EXAMPLE_L1B___9:test_file09", "properties": {"start_datetime": "2016-01-31T18:00:00.009057Z", "end_datetime": "2016-01-31T19:59:59.991043Z", "created": "2016-02-01T02:45:59.639000Z", "updated": "2022-03-23T15:48:21.578000Z", "datetime": "1970-01-01T00:00:00Z"}, "geometry": {"type": "Point", "coordinates": [0.0, 0.0]}, "links": [], "assets": {"test_file09.nc": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file09/test_file09.nc", "title": "test_file01.nc", "roles": ["data"]}, "test_file09.nc.cas": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file09/test_file09.nc.cas", "title": "test_file01.nc.cas", "roles": ["metadata"]}, "test_file09.nc.stac.json": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file09/test_file09.nc.stac.json", "title": "test_file01.nc.stac.json", "roles": ["metadata"]}}, "bbox": [0.0, 0.0, 0.0, 0.0], "stac_extensions": [], "collection": "NEW_COLLECTION_EXAMPLE_L1B___9"}]}
        result = ItemCollection.from_dict(result)
        a = GranulesCnmIngesterLogic()
        a.successful_features = result
        a.validate_granules()
        return

    def test_extract_collection_id(self):
        result = {"type": "FeatureCollection", "features": [{"type": "Feature", "stac_version": "1.0.0", "id": "NEW_COLLECTION_EXAMPLE_L1B___9:test_file01", "properties": {"start_datetime": "2016-01-31T18:00:00.009057Z", "end_datetime": "2016-01-31T19:59:59.991043Z", "created": "2016-02-01T02:45:59.639000Z", "updated": "2022-03-23T15:48:21.578000Z", "datetime": "1970-01-01T00:00:00Z"}, "geometry": {"type": "Point", "coordinates": [0.0, 0.0]}, "links": [], "assets": {"test_file01.nc": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file01/test_file01.nc", "title": "test_file01.nc", "roles": ["data"]}, "test_file01.nc.cas": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file01/test_file01.nc.cas", "title": "test_file01.nc.cas", "roles": ["metadata"]}, "test_file01.nc.stac.json": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file01/test_file01.nc.stac.json", "title": "test_file01.nc.stac.json", "roles": ["metadata"]}}, "bbox": [0.0, 0.0, 0.0, 0.0], "stac_extensions": [], "collection": "NEW_COLLECTION_EXAMPLE_L1B___9"}, {"type": "Feature", "stac_version": "1.0.0", "id": "NEW_COLLECTION_EXAMPLE_L1B___9:test_file02", "properties": {"start_datetime": "2016-01-31T18:00:00.009057Z", "end_datetime": "2016-01-31T19:59:59.991043Z", "created": "2016-02-01T02:45:59.639000Z", "updated": "2022-03-23T15:48:21.578000Z", "datetime": "1970-01-01T00:00:00Z"}, "geometry": {"type": "Point", "coordinates": [0.0, 0.0]}, "links": [], "assets": {"test_file02.nc": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file02/test_file02.nc", "title": "test_file01.nc", "roles": ["data"]}, "test_file02.nc.cas": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file02/test_file02.nc.cas", "title": "test_file01.nc.cas", "roles": ["metadata"]}, "test_file02.nc.stac.json": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file02/test_file02.nc.stac.json", "title": "test_file01.nc.stac.json", "roles": ["metadata"]}}, "bbox": [0.0, 0.0, 0.0, 0.0], "stac_extensions": [], "collection": "NEW_COLLECTION_EXAMPLE_L1B___9"}, {"type": "Feature", "stac_version": "1.0.0", "id": "NEW_COLLECTION_EXAMPLE_L1B___9:test_file03", "properties": {"start_datetime": "2016-01-31T18:00:00.009057Z", "end_datetime": "2016-01-31T19:59:59.991043Z", "created": "2016-02-01T02:45:59.639000Z", "updated": "2022-03-23T15:48:21.578000Z", "datetime": "1970-01-01T00:00:00Z"}, "geometry": {"type": "Point", "coordinates": [0.0, 0.0]}, "links": [], "assets": {"test_file03.nc": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file03/test_file03.nc", "title": "test_file01.nc", "roles": ["data"]}, "test_file03.nc.cas": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file03/test_file03.nc.cas", "title": "test_file01.nc.cas", "roles": ["metadata"]}, "test_file03.nc.stac.json": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file03/test_file03.nc.stac.json", "title": "test_file01.nc.stac.json", "roles": ["metadata"]}}, "bbox": [0.0, 0.0, 0.0, 0.0], "stac_extensions": [], "collection": "NEW_COLLECTION_EXAMPLE_L1B___9"}, {"type": "Feature", "stac_version": "1.0.0", "id": "NEW_COLLECTION_EXAMPLE_L1B___9:test_file04", "properties": {"start_datetime": "2016-01-31T18:00:00.009057Z", "end_datetime": "2016-01-31T19:59:59.991043Z", "created": "2016-02-01T02:45:59.639000Z", "updated": "2022-03-23T15:48:21.578000Z", "datetime": "1970-01-01T00:00:00Z"}, "geometry": {"type": "Point", "coordinates": [0.0, 0.0]}, "links": [], "assets": {"test_file04.nc": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file04/test_file04.nc", "title": "test_file01.nc", "roles": ["data"]}, "test_file04.nc.cas": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file04/test_file04.nc.cas", "title": "test_file01.nc.cas", "roles": ["metadata"]}, "test_file04.nc.stac.json": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file04/test_file04.nc.stac.json", "title": "test_file01.nc.stac.json", "roles": ["metadata"]}}, "bbox": [0.0, 0.0, 0.0, 0.0], "stac_extensions": [], "collection": "NEW_COLLECTION_EXAMPLE_L1B___9"}, {"type": "Feature", "stac_version": "1.0.0", "id": "NEW_COLLECTION_EXAMPLE_L1B___9:test_file05", "properties": {"start_datetime": "2016-01-31T18:00:00.009057Z", "end_datetime": "2016-01-31T19:59:59.991043Z", "created": "2016-02-01T02:45:59.639000Z", "updated": "2022-03-23T15:48:21.578000Z", "datetime": "1970-01-01T00:00:00Z"}, "geometry": {"type": "Point", "coordinates": [0.0, 0.0]}, "links": [], "assets": {"test_file05.nc": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file05/test_file05.nc", "title": "test_file01.nc", "roles": ["data"]}, "test_file05.nc.cas": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file05/test_file05.nc.cas", "title": "test_file01.nc.cas", "roles": ["metadata"]}, "test_file05.nc.stac.json": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file05/test_file05.nc.stac.json", "title": "test_file01.nc.stac.json", "roles": ["metadata"]}}, "bbox": [0.0, 0.0, 0.0, 0.0], "stac_extensions": [], "collection": "NEW_COLLECTION_EXAMPLE_L1B___9"}, {"type": "Feature", "stac_version": "1.0.0", "id": "NEW_COLLECTION_EXAMPLE_L1B___9:test_file06", "properties": {"start_datetime": "2016-01-31T18:00:00.009057Z", "end_datetime": "2016-01-31T19:59:59.991043Z", "created": "2016-02-01T02:45:59.639000Z", "updated": "2022-03-23T15:48:21.578000Z", "datetime": "1970-01-01T00:00:00Z"}, "geometry": {"type": "Point", "coordinates": [0.0, 0.0]}, "links": [], "assets": {"test_file06.nc": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file06/test_file06.nc", "title": "test_file01.nc", "roles": ["data"]}, "test_file06.nc.cas": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file06/test_file06.nc.cas", "title": "test_file01.nc.cas", "roles": ["metadata"]}, "test_file06.nc.stac.json": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file06/test_file06.nc.stac.json", "title": "test_file01.nc.stac.json", "roles": ["metadata"]}}, "bbox": [0.0, 0.0, 0.0, 0.0], "stac_extensions": [], "collection": "NEW_COLLECTION_EXAMPLE_L1B___9"}, {"type": "Feature", "stac_version": "1.0.0", "id": "NEW_COLLECTION_EXAMPLE_L1B___9:test_file08", "properties": {"start_datetime": "2016-01-31T18:00:00.009057Z", "end_datetime": "2016-01-31T19:59:59.991043Z", "created": "2016-02-01T02:45:59.639000Z", "updated": "2022-03-23T15:48:21.578000Z", "datetime": "1970-01-01T00:00:00Z"}, "geometry": {"type": "Point", "coordinates": [0.0, 0.0]}, "links": [], "assets": {"test_file08.nc": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file08/test_file08.nc", "title": "test_file01.nc", "roles": ["data"]}, "test_file08.nc.cas": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file08/test_file08.nc.cas", "title": "test_file01.nc.cas", "roles": ["metadata"]}, "test_file08.nc.stac.json": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file08/test_file08.nc.stac.json", "title": "test_file01.nc.stac.json", "roles": ["metadata"]}}, "bbox": [0.0, 0.0, 0.0, 0.0], "stac_extensions": [], "collection": "NEW_COLLECTION_EXAMPLE_L1B___9"}, {"type": "Feature", "stac_version": "1.0.0", "id": "NEW_COLLECTION_EXAMPLE_L1B___9:test_file07", "properties": {"start_datetime": "2016-01-31T18:00:00.009057Z", "end_datetime": "2016-01-31T19:59:59.991043Z", "created": "2016-02-01T02:45:59.639000Z", "updated": "2022-03-23T15:48:21.578000Z", "datetime": "1970-01-01T00:00:00Z"}, "geometry": {"type": "Point", "coordinates": [0.0, 0.0]}, "links": [], "assets": {"test_file07.nc": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file07/test_file07.nc", "title": "test_file01.nc", "roles": ["data"]}, "test_file07.nc.cas": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file07/test_file07.nc.cas", "title": "test_file01.nc.cas", "roles": ["metadata"]}, "test_file07.nc.stac.json": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file07/test_file07.nc.stac.json", "title": "test_file01.nc.stac.json", "roles": ["metadata"]}}, "bbox": [0.0, 0.0, 0.0, 0.0], "stac_extensions": [], "collection": "NEW_COLLECTION_EXAMPLE_L1B___9"}, {"type": "Feature", "stac_version": "1.0.0", "id": "NEW_COLLECTION_EXAMPLE_L1B___9:test_file10", "properties": {"start_datetime": "2016-01-31T18:00:00.009057Z", "end_datetime": "2016-01-31T19:59:59.991043Z", "created": "2016-02-01T02:45:59.639000Z", "updated": "2022-03-23T15:48:21.578000Z", "datetime": "1970-01-01T00:00:00Z"}, "geometry": {"type": "Point", "coordinates": [0.0, 0.0]}, "links": [], "assets": {"test_file10.nc": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file10/test_file10.nc", "title": "test_file01.nc", "roles": ["data"]}, "test_file10.nc.cas": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file10/test_file10.nc.cas", "title": "test_file01.nc.cas", "roles": ["metadata"]}, "test_file10.nc.stac.json": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file10/test_file10.nc.stac.json", "title": "test_file01.nc.stac.json", "roles": ["metadata"]}}, "bbox": [0.0, 0.0, 0.0, 0.0], "stac_extensions": [], "collection": "NEW_COLLECTION_EXAMPLE_L1B___9"}, {"type": "Feature", "stac_version": "1.0.0", "id": "NEW_COLLECTION_EXAMPLE_L1B___9:test_file09", "properties": {"start_datetime": "2016-01-31T18:00:00.009057Z", "end_datetime": "2016-01-31T19:59:59.991043Z", "created": "2016-02-01T02:45:59.639000Z", "updated": "2022-03-23T15:48:21.578000Z", "datetime": "1970-01-01T00:00:00Z"}, "geometry": {"type": "Point", "coordinates": [0.0, 0.0]}, "links": [], "assets": {"test_file09.nc": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file09/test_file09.nc", "title": "test_file01.nc", "roles": ["data"]}, "test_file09.nc.cas": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file09/test_file09.nc.cas", "title": "test_file01.nc.cas", "roles": ["metadata"]}, "test_file09.nc.stac.json": {"href": "s3://uds-sbx-cumulus-staging/NEW_COLLECTION_EXAMPLE_L1B___9/NEW_COLLECTION_EXAMPLE_L1B___9:test_file09/test_file09.nc.stac.json", "title": "test_file01.nc.stac.json", "roles": ["metadata"]}}, "bbox": [0.0, 0.0, 0.0, 0.0], "stac_extensions": [], "collection": "NEW_COLLECTION_EXAMPLE_L1B___9"}]}
        result = ItemCollection.from_dict(result)
        a = GranulesCnmIngesterLogic()
        a.successful_features = result
        a.extract_collection_id()
        self.assertEqual(a.collection_id, 'NEW_COLLECTION_EXAMPLE_L1B___9')
        return

    def test_create_collection(self):
        a = GranulesCnmIngesterLogic()
        self.tenant = 'UDS_LOCAL_TEST'  # 'uds_local_test'  # 'uds_sandbox'
        self.tenant_venue = 'DEV'  # 'DEV1'  # 'dev'
        self.collection_name = 'UDS_COLLECTION_CNM_INGESTION'  # 'uds_collection'  # 'sbx_collection'
        self.collection_version = '24.04.24.06.00'.replace('.', '')  # '2402011200'
        temp_collection_id = f'URN:NASA:UNITY:{self.tenant}:{self.tenant_venue}:{self.collection_name}___{self.collection_version}'
        a.collection_id = temp_collection_id
        a.create_collection()
        return

    def test_send_cnm_msg(self):
        result = '''{"type": "FeatureCollection", "features": [{"type": "Feature", "stac_version": "1.0.0", "id": "URN:NASA:UNITY:UDS_LOCAL_TEST:DEV:UDS_COLLECTION___2404240700:abcd.1234.efgh.test_file05", "properties": {"tag": "#sample", "c_data1": [1, 10, 100, 1000], "c_data2": [false, true, true, false, true], "c_data3": ["Bellman Ford"], "soil10": {"0_0": 0, "0_1": 1, "0_2": 0}, "start_datetime": "2016-01-31T18:00:00.009057Z", "end_datetime": "2016-01-31T19:59:59.991043Z", "created": "2016-02-01T02:45:59.639000Z", "updated": "2022-03-23T15:48:21.578000Z", "datetime": "1970-01-01T00:00:00Z"}, "geometry": {"type": "Point", "coordinates": [0.0, 0.0]}, "links": [], "assets": {"abcd.1234.efgh.test_file05.data.stac.json": {"href": "s3://uds-sbx-cumulus-staging/URN:NASA:UNITY:UDS_LOCAL_TEST:DEV:UDS_COLLECTION___2404240700/URN:NASA:UNITY:UDS_LOCAL_TEST:DEV:UDS_COLLECTION___2404240700:abcd.1234.efgh.test_file05/abcd.1234.efgh.test_file05.data.stac.json", "title": "abcd.1234.efgh.test_file05.data.stac.json", "roles": ["data"]}, "abcd.1234.efgh.test_file05.nc.cas": {"href": "s3://uds-sbx-cumulus-staging/URN:NASA:UNITY:UDS_LOCAL_TEST:DEV:UDS_COLLECTION___2404240700/URN:NASA:UNITY:UDS_LOCAL_TEST:DEV:UDS_COLLECTION___2404240700:abcd.1234.efgh.test_file05/abcd.1234.efgh.test_file05.nc.cas", "title": "abcd.1234.efgh.test_file05.nc.cas", "roles": ["metadata"]}, "abcd.1234.efgh.test_file05.nc.stac.json": {"href": "s3://uds-sbx-cumulus-staging/URN:NASA:UNITY:UDS_LOCAL_TEST:DEV:UDS_COLLECTION___2404240700/URN:NASA:UNITY:UDS_LOCAL_TEST:DEV:UDS_COLLECTION___2404240700:abcd.1234.efgh.test_file05/abcd.1234.efgh.test_file05.nc.stac.json", "title": "abcd.1234.efgh.test_file05.nc.stac.json", "roles": ["metadata"]}}, "bbox": [0.0, 0.0, 0.0, 0.0], "stac_extensions": [], "collection": "URN:NASA:UNITY:UDS_LOCAL_TEST:DEV:UDS_COLLECTION___2404240700"}]}
        '''
        result = json.loads(result)
        a = GranulesCnmIngesterLogic()
        a.successful_features_json = result
        a.send_cnm_msg()
        return
